name: Deploy Blog

on:
  push:
    branches: [main]
    paths:
      - 'Posts/**'
      - 'Pipeline/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        default: 'stage'
        type: choice
        options:
          - stage
          - production

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.posts }}
      deployment-mode: ${{ steps.mode.outputs.mode }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to detect first commit
      
      - name: Determine deployment mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.mode }}"
          else
            # Default to staging for automatic pushes
            MODE="stage"
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "Deployment mode: $MODE"
      
      - name: Detect changed posts
        id: changes
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Checking for posts in Posts/ directory..."
          ls -la Posts/ || echo "Posts directory not found"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - process all posts
            echo "Manual trigger - processing all posts"
            POSTS=$(find Posts -name "*.md" -type f 2>/dev/null | tr '\n' ' ')
          else
            # Push trigger - check commit history
            COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
            echo "Commit count: $COMMIT_COUNT"
            
            if [ "$COMMIT_COUNT" -le "1" ]; then
              # First commit or very few commits - process all posts
              echo "First commit detected - processing all posts"
              POSTS=$(find Posts -name "*.md" -type f 2>/dev/null | tr '\n' ' ')
            else
              # Check for changed files
              echo "Checking for changed files..."
              POSTS=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep "^Posts/.*\.md$" | tr '\n' ' ' || echo "")
              if [ -z "$POSTS" ]; then
                # No changed posts, but process all for initial setup
                echo "No changed posts, but processing all for initial deployment"
                POSTS=$(find Posts -name "*.md" -type f 2>/dev/null | tr '\n' ' ')
              fi
            fi
          fi
          
          if [ -z "$POSTS" ]; then
            echo "No posts to process"
            echo "posts=" >> $GITHUB_OUTPUT
          else
            echo "Found posts: $POSTS"
            echo "posts=$POSTS" >> $GITHUB_OUTPUT
          fi
  
  process-posts:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.changed-files != ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install script dependencies
        run: |
          cd Pipeline/scripts
          npm install
      
      - name: Process posts
        id: process
        run: |
          cd Pipeline/scripts
          POSTS="${{ needs.detect-changes.outputs.changed-files }}"
          
          for post in $POSTS; do
            echo "Processing: $post"
            node process-post.js "../../$post" || exit 1
          done
          
          echo "All posts processed successfully"
  
  publish-to-platforms:
    needs: [detect-changes, process-posts]
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.changed-files != ''
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install script dependencies
        run: |
          cd Pipeline/scripts
          npm install
      
      - name: Publish to platforms
        env:
          MEDIUM_TOKEN: ${{ secrets.MEDIUM_TOKEN }}
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_ORG_ID: ${{ secrets.LINKEDIN_ORG_ID }}
          DRAFT_MODE: ${{ needs.detect-changes.outputs.deployment-mode == 'stage' && 'true' || 'false' }}
          METADATA_FILE: ${{ github.workspace }}/../Local/.local/metadata.json
        run: |
          cd Pipeline/scripts
          POSTS="${{ needs.detect-changes.outputs.changed-files }}"
          MODE="${{ needs.detect-changes.outputs.deployment-mode }}"
          
          # Create metadata directory
          mkdir -p ../../.local
          
          for post in $POSTS; do
            echo "Publishing: $post (mode: $MODE)"
            node publish-all.js "../../$post" || echo "Failed to publish $post, continuing..."
          done
      
      - name: Upload metadata
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: publish-metadata
          path: .local/metadata.json
          if-no-files-found: ignore
  
  build-site:
    needs: [detect-changes, process-posts]
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.changed-files != ''
    # Note: Can run in parallel with publish-to-platforms (both depend on process-posts)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Copy posts to Astro content directory
        run: |
          mkdir -p Pipeline/site/src/content/blog
          mkdir -p Pipeline/site/public/Images
          cp Posts/*.md Pipeline/site/src/content/blog/ || true
          cp -r Images/* Pipeline/site/public/Images/ || true
          
          # Normalize frontmatter (convert Date objects to strings for Astro)
          cd Pipeline/scripts
          npm install
          for post in ../../site/src/content/blog/*.md; do
            if [ -f "$post" ]; then
              node normalize-frontmatter.js "$post"
            fi
          done
          cd ../..
          
          # Generate CNAME file from config (create directory first)
          mkdir -p Pipeline/site/public
          cd Pipeline/scripts
          BLOG_DOMAIN="${{ secrets.BLOG_DOMAIN || 'blog.YOUR_DOMAIN.com' }}" \
          GITHUB_USERNAME="${{ secrets.GITHUB_USERNAME || 'YOUR_GITHUB_USERNAME' }}" \
          node generate-cname.js ../../site/public/CNAME
          cd ../..
          
          # Fix image paths in markdown files (../Images/ -> /Images/)
          find Pipeline/site/src/content/blog -name "*.md" -exec sed -i 's|../Images/|/Images/|g' {} \;
      
      - name: Install Astro dependencies
        run: |
          cd Pipeline/site
          npm install
      
      - name: Build Astro site
        run: |
          cd Pipeline/site
          npm run build
      
      - name: Create .nojekyll file
        run: |
          touch Pipeline/build/.nojekyll
          echo "Created .nojekyll to disable Jekyll processing"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: Pipeline/build
          retention-days: 7
  
  deploy-github-pages:
    needs: build-site
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./build-output
      
      - name: Verify build output
        run: |
          echo "Build output contents:"
          ls -la ./build-output/Pipeline/build/ || ls -la ./build-output/ || echo "Checking root..."
          ls -la ./
          echo "Looking for index.html:"
          find . -name "index.html" -type f | head -5
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./build-output/Pipeline/build
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  deploy-vercel:
    needs: build-site
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.deployment-mode == 'production'
    continue-on-error: true
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          cd Pipeline/build
          vercel --prod --token $VERCEL_TOKEN --yes
